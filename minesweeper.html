<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html><head><script type="text/javascript" src="jquery-1.7.1.js"></script><script type="text/javascript" src="jquery.cookie.js"></script><script type="text/javascript" src="utils.js"></script><script type="text/javascript" src="sweeper.js"></script><script type="text/javascript">//class UIfunction UI() {		var sweeper;	this.setSweeper = function(_sweeper) { sweeper = _sweeper; }	this.getSweeper = function() { return sweeper; }		//TODO - make next 2 functions static	this.XYToCellId = function(x, y) {		return 'r' + x + 'h' + y;	}		this.cellIdToXY = function(rh) {		return { 			x : Number(rh.match(/^r(\d+)/)[1]), 			y : Number(rh.match(/h(\d+)$/)[1])		};				}		this.show = function(cells, minesRemained, seconds) {		for (var i in cells) {			var row = 'r'+i;			$('#field').append('<tr id='+ row + '>');			for (var j in cells[i]) {				var id = this.XYToCellId(i, j);				var html = '<td id="' + id +'" class="cell" onmousedown="onCellClick(\'' + id + '\')" align=\'center\'></td>';				$('#'+row).append(html);				this.refreshCell(cells[i][j], i, j);			}			$("#field").append('</tr>');		}		this.refreshMinesRemained(minesRemained);		this.refreshSeconds(seconds);	}		this.refreshCell = function(cell, x, y) {		var rh = this.XYToCellId(x, y);		var state = this.getSweeper().getStateManager().getCurrentState() ;		var markFlag = function() {			$('#'+rh).html('<img src="img/flag.png"></img>');		};		var showMine = function() {			$('#'+rh).html('<img src="img/mine.png"></img>');		};		var setClickedBackground = function() {			$('#'+rh).attr('class', 'clickedCell');		};		if (!cell.clicked) {			var html = '';			switch (cell.mark) {				case Mark.FLAG: 					if (state == State.GAME_OVER && 						cell.content != Content.MINE) {	//draw cross						$('#'+rh).html('<img src="img/cross.png"></img>');					} else {						markFlag();					}					break;				case Mark.QUESTION:					if (state == State.GAME_OVER &&						cell.content == Content.MINE){						showMine();						setClickedBackground();					} else {						$('#'+rh).html('<img src="img/question.png"></img>');					}					break;				case Mark.NONE:					if (state == State.FINISH &&						cell.content == Content.MINE) {						markFlag();					} else if (state == State.GAME_OVER &&							   cell.content == Content.MINE){						showMine();						setClickedBackground();						return;					} else {						$('#'+rh).html('');					}					break;				default: 					throw 'unknown mark ' + cell.mark;			}		} else {			switch (cell.content) {				case Content.MINE:					showMine();					$('#'+rh).css('background-color', 'red');					return;				case Content.NONE:					$('#'+rh).html('');					break;				case Content.ONE:					$('#'+rh).html('1');					$('#'+rh).css('color', 'blue');					break;				case Content.TWO:					$('#'+rh).html('2');					$('#'+rh).css('color', 'green');					break;				case Content.THREE:					$('#'+rh).html('3');					$('#'+rh).css('color', 'red');					break;				case Content.FOUR:					$('#'+rh).html('4');					$('#'+rh).css('color', 'blue');				break;				case Content.FIVE:					$('#'+rh).html('5');					$('#'+rh).css('color', 'brown');				break;				case Content.SIX:					$('#'+rh).html('6');					$('#'+rh).css('color', 'turquoise');				break;				case Content.SEVEN:					$('#'+rh).html('7');					$('#'+rh).css('color', 'black');				break;				case Content.EIGHT:					$('#'+rh).html('8');					$('#'+rh).css('color', 'silver');				break;				default:					$('#'+rh).html(cell.content);			}			setClickedBackground();		}	}		this.refreshMinesRemained = function(minesRemained) {		$('#mines').html(minesRemained);	}	this.refreshSeconds = function(seconds) {		$('#seconds').html(seconds);	}		this.clear = function() {		$('#field').html('');	}}var sweeper, ui;var x = 5, y = 5, mines = 5;var scores = new Array();function newGame() {	var ux = $.cookie('xSize');		uy = $.cookie('ySize');		umines = $.cookie('mines');	if (ux != null && uy != null && umines != null) {		x = ux;		y = uy;		mines = umines;	}		//default values	if (x < 5 || y < 5 || mines < 1) {		x = 5;		y = 5;		mines = 5;	}		if (ui != null && sweeper != null) {		ui.clear();		sweeper.dispose()	} 		ui = new UI();	sweeper = new Sweeper(x, y, mines, ui);		onCellClick = function(rh) {		var xy = ui.cellIdToXY(rh);		if (event.which == 1) { //left click			sweeper.clickCell(xy.x, xy.y);		} else if (event.which == 3) { //right click			sweeper.markCell(xy.x, xy.y);		}		if (sweeper.getStateManager().getCurrentState() == State.FINISH) {			var score = Math.floor( (100 * mines / (x * y)) * (mines + x * y) / ((sweeper.getSeconds() + 1) / 10));			addScore(score);			saveScores(scores);		}	}		//refresh scores	$('#scoresContainer').html('');	getScores();	for (var i in scores) {		$('#scoresContainer').append('<p>' + (Number(i) + 1) + '. ' + scores[i].name + ' - ' + scores[i].score + '.</p>');	}}//class Scorefunction Score(name, score) {	this.name = name;	this.score = score;}function getScores() {	var cookieScores = $.cookie('scores');	if (cookieScores != null) {				scores = new Array();		var scoresArray = cookieScores.split('|');					for (var i in scoresArray) {			var name = scoresArray[i].split(' ')[0];			var score = scoresArray[i].split(' ')[1];			scores.push(new Score(name, score));			}	} else if (scores.length == 0) {		scores.push(new Score('expert', 10000));		scores.push(new Score('advanced', 5000));		scores.push(new Score('rookie', 1000));	}}function saveScores() {	scores.sort(function(a, b) {		return Number(a.score) < Number(b.score);	});		var scoresStr = scores[0].name + ' ' + scores[0].score;	for (var i in scores) {		if (i == 0) {			++i;		}		if (i >= 5) {			scores.pop();			continue;		}		scoresStr += '|' + scores[i].name + ' ' + scores[i].score;	}	$.cookie('scores', scoresStr, { expires: 7, path: 'minesweeper.ales.by' });}function addScore(score) {	var name = prompt("Congratulations! Your score is " + score + ".\nPlease enter your name for history:");	if (name == null || name == '') {		name = 'Anonymous';	}	scores.push(new Score(name, score));}var onCellClick = null;$(document).ready(function(){	newGame();});function showSettingsDialog() {	$('#gameContainer').css('display', 'none');	$('#scoresContainer').css('display', 'none');	$('#settingsContainer').css('display', 'block');}function saveSettings() {	var xx = Number($('#xSize').attr('value'));	var yy = Number($('#ySize').attr('value'));	var mmines = Number($('#minesCount').attr('value'));		if (xx < 5 || yy < 5 || mmines < 1) {		alert('wrong settings');		return;	} else {		x = xx;		y = yy;		mines = mmines;				$.cookie('xSize', xx, { expires: 7 }); 		$.cookie('ySize', yy, { expires: 7 });		$.cookie('mines', mmines, { expires: 7 });			newGame();			$('#settingsContainer').css('display', 'none');		$('#scoresContainer').css('display', 'block');		$('#gameContainer').css('display', 'block');	}}function cancelSettings() {	$('#settingsContainer').css('display', 'none');	$('#scoresContainer').css('display', 'block');	$('#gameContainer').css('display', 'block');}</script><style type="text/css">body { background-color:azure; }.field {	border-left: solid 3px grey;	border-top: solid 3px grey;	border-right: solid 3px Gainsboro;	border-bottom: solid 3px Gainsboro;	border-spacing: 0px;	font-size: 20px; 	font-family: 'Arial';	font-weight: bold;}.field tr {	height: 36px;}.cell{	width:30px; height:30px; 	border-left: solid 3px Gainsboro;	border-top: solid 3px Gainsboro;	border-right: solid 3px grey;	border-bottom: solid 3px grey;	background-color: silver; }.clickedCell {	width:34px; height:34px; 	border: dotted 1px grey;	background-color: white;}.cell img, .clickedCell img { width:28px; height:28px }#seconds{	align: left;	background-color: red;}#mines{	align: right;	background-color: red;}</style></head><body><div id='gameContainer' oncontextmenu='return false'>	<button id='newGame' type='button' onclick='newGame()'>new game</button>	<button id='settings' type='button' onclick='showSettingsDialog()'>settings</button>	<table>		<tr>			<td id='newGameCell'></td>		</tr>		<tr>			<td id='seconds'></td>			<td id='newGame'></td>			<td id='mines'></td>		</tr>		<tr id='cells'>			<td colspan='3'>				<table id='field' class='field'></table>			</td>		</tr>	</table></div><div id='settingsContainer' style='display: none'>	<p>x: <input id='xSize' value='5'></input></p>	<p>y: <input id='ySize' value='5'></input></p>	<p>mines: <input id='minesCount' value='5'></input></p>	<button id='save' type='button' onclick='saveSettings()'>save</button>	<button id='cancel' type='button' onclick='cancelSettings()'>cancel</button></div><div id='scoresContainer'>	</div></body></html>